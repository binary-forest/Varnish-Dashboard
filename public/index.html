<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Varnish Dashbaord</title>
        <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
        <!-- bootstrap 3.0.2 -->
        <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <!-- font Awesome -->
        <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" />
        <!-- Ionicons -->
        <link href="css/ionicons.min.css" rel="stylesheet" type="text/css" />
        <!-- Theme style -->
        <link href="css/AdminLTE.css" rel="stylesheet" type="text/css" />

        <link href="css/dashboard.css" rel="stylesheet" type="text/css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
          <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
    </head>
    <body class="skin-black">
        <!-- header logo: style can be found in header.less -->
        <header class="header">
            <a href="index.html" class="logo">
                <!-- Add the class icon to your logo image or logo icon to add the margining -->
                Varnish Dashboard
            </a>
            <!-- Header Navbar: style can be found in header.less -->
            <nav class="navbar navbar-static-top" role="navigation">
                <!-- Sidebar toggle button-->
                <a href="#" class="navbar-btn sidebar-toggle" data-toggle="offcanvas" role="button">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>
                
        </header>
        <div class="wrapper row-offcanvas row-offcanvas-left">
            <!-- Left side column. contains the logo and sidebar -->
            <aside class="left-side sidebar-offcanvas">                
                <!-- sidebar: style can be found in sidebar.less -->
                <section class="sidebar">
                    
                    <!-- sidebar menu: : style can be found in sidebar.less -->
                    <ul class="sidebar-menu">
                        <li class="active">
                            <a href="#">
                                <i class="fa fa-dashboard"></i> <span>Dashboard</span>
                            </a>
                        </li>
                        <li class="">
                            <a href="vcl.html">
                                <i class="fa fa-dashboard"></i> <span>VCL</span>
                            </a>
                        </li>
                        <li class="">
                            <a href="ban.html">
                                <i class="fa fa-dashboard"></i> <span>Ban</span>
                            </a>
                        </li>
                    </ul>
                </section>
                <!-- /.sidebar -->
            </aside>

            <!-- Right side column. Contains the navbar and content of the page -->
            <aside class="right-side">                
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>Varnish Dashboard <small>Status</small></h1>
                    <ol class="breadcrumb">
                        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
                        <li class="active">Dashboard</li>
                    </ol>
                </section>

                <!-- Main content -->
                <section class="content">


                    <!-- Main row -->
                    <div class="row">

                        <div class="row">
                            <div class="col-xs-12">
                                <div class="box box-primary">
                                    <div class="box-header" data-toggle="tooltip" title="Varnish Alerts">
                                        <!-- tools box -->
                                        <div class="pull-right box-tools">
                                            <button class="btn btn-primary btn-sm" data-widget='collapse' data-toggle="tooltip" title="Collapse"><i class="fa fa-minus"></i></button>
                                            <button class="btn btn-primary btn-sm" data-widget='remove' data-toggle="tooltip" title="Remove"><i class="fa fa-times"></i></button>
                                        </div><!-- /. tools -->
                                        <i class="fa fa-globe"></i>
                                        <h3 class="box-title">Varnish Alerts </h3>
                                    </div><!-- /.box-header -->
                                    <div class="box-body">
                                        <div class="row">
                                            <div class="box-body" id="varnishAlerts">

                                            </div>
                                        </div><!-- /.websitestatus -->

                                    </div><!-- /.box-body-->
                                </div><!-- /.box -->

                            </div><!-- /.col -->
                        </div><!-- /.row -->


                        <div class="row">
                            <div class="col-xs-12">
                                <div class="box box-primary">
                                    <div class="box-header" data-toggle="tooltip" title="Varnish Alerts">
                                        <!-- tools box -->
                                        <div class="pull-right box-tools">
                                            <button class="btn btn-primary btn-sm" data-widget='collapse' data-toggle="tooltip" title="Collapse"><i class="fa fa-minus"></i></button>
                                            <button class="btn btn-primary btn-sm" data-widget='remove' data-toggle="tooltip" title="Remove"><i class="fa fa-times"></i></button>
                                        </div><!-- /. tools -->
                                        <i class="fa fa-globe"></i>
                                        <h3 class="box-title">Varnish Stats <small>Realtime</small></h3>
                                    </div><!-- /.box-header -->
                                    <div class="box-body">
                                        <div class="row">
                                            <div class="box-body" >
                                                <div class="col-xs-12 col-sm-12 col-md-8 col-lg-8 varnish-chart" id="HitRateStats">
                                                </div>
                                                <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 varnish-add-stats" id="ServerStats">
                                                </div>
                                                <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 varnish-add-stats" id="HitRatioStats">
                                                </div>
                                                <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 varnish-add-stats" id="transferStats">
                                                </div>
                                            </div>
                                        </div>

                                    </div><!-- /.box-body-->
                                    <div class="box-footer">
                                        <div class="row">
                                            <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3 text-center" style="border-right: 1px solid #f4f4f4">
                                                <input type="text" id='server-info-cpu-knob' class="knob server-info-knob" data-thickness=".2" data-readonly="true" value="0" data-width="50" data-height="50" />
                                                <span class="pie-title">CPU</span>
                                            </div><!-- ./col -->
                                            <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3 text-center" style="border-right: 1px solid #f4f4f4">
                                                <input type="text" id='server-info-cpuload-knob' class="knob server-info-knob" data-thickness=".2" data-readonly="true" value="0" data-width="50" data-height="50" />
                                                <span class="pie-title">CPU Load</span>
                                            </div><!-- ./col -->
                                            <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3 text-center" style="border-right: 1px solid #f4f4f4">
                                                <input type="text" id='server-info-memory-knob' class="knob server-info-knob" data-thickness=".2" data-readonly="true" value="0" data-width="50" data-height="50" />
                                                <span class="pie-title">Memory</span>
                                            </div><!-- ./col -->
                                            <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3 text-center" style="border-right: 1px solid #f4f4f4">
                                                <input type="text" id='server-info-hitrate-knob' class="knob server-info-knob" data-thickness=".2" data-readonly="true" value="0" data-width="50" data-height="50" />
                                                <span class="pie-title">Hit Rate</span>
                                            </div><!-- ./col -->
                                        </div><!-- /.row -->
                                    </div><!-- /.box-footer -->
                                </div><!-- /.box -->

                            </div><!-- /.col -->


                        </div><!-- /.row -->


                    </div> <!-- end main row -->

                </section><!-- /.content -->
            </aside><!-- /.right-side -->
        </div><!-- ./wrapper -->


        <!-- jQuery 2.0.2 -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
        <!-- jQuery UI 1.10.3 -->
        <script src="js/jquery-ui-1.10.3.min.js" type="text/javascript"></script>
        <!-- Bootstrap -->
        <script src="js/bootstrap.min.js" type="text/javascript"></script>

        <!-- jQuery Knob Chart -->
        <script src="js/plugins/jqueryKnob/jquery.knob.js" type="text/javascript"></script>

        <!-- AdminLTE App -->
        <script src="js/AdminLTE/app.js" type="text/javascript"></script>
        <!-- Sparkline -->
        <script src="js/plugins/sparkline/jquery.sparkline.min.js" type="text/javascript"></script>

        <!-- FLOT CHARTS -->
        <script src="js/plugins/flot/jquery.flot.min.js" type="text/javascript"></script>
        <script src="js/plugins/flot/jquery.flot.time.min.js" type="text/javascript"></script>
        
        <!-- FLOT RESIZE PLUGIN - allows the chart to redraw when the window is resized -->
        <script src="js/plugins/flot/jquery.flot.resize.min.js" type="text/javascript"></script>
        <!-- FLOT PIE PLUGIN - also used to draw donut charts -->
        <script src="js/plugins/flot/jquery.flot.pie.min.js" type="text/javascript"></script>
        <!-- FLOT CATEGORIES PLUGIN - Used to draw bar charts -->
        <script src="js/plugins/flot/jquery.flot.categories.min.js" type="text/javascript"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>

        <script>
            var socket = io.connect('codeblack.eu:3001');

            // setup knobs for Server performance with custom colours
            $('.server-info-knob').knob({
                    'draw' : function (v) {
                        if (this.v >= 80) {
                            this.o.fgColor='red';
                            console.log('Set knob color to Critical');
                        } else if (this.v >= 60) {
                            this.o.fgColor='#FF6600';
                            console.log('Set knob color to Amber');
                        } else {
                            this.o.fgColor='green';
                            console.log('Set knob color to Green');
                        }
                    }
                }
            );
            // end setup knobs for Server performance with custom colours

            var mpoints_max = 300;

            var DiskData = [];
            var CPUData = [];
            var MemData = [];
            // var data1month = [];
            var serverStatsDataDetails = [
                {
                    label: "Disk Stats",
                    data: DiskData,
                    lines: {
                        show: true,
                        fill: false
                    },
                    points: {
                        show: true,
                        radius: '1',
                        fillColor: '#006600'
                    },
                    color: '#006600'
                },
                {
                    label: "Memory Stats",
                    data: MemData,
                    lines: {
                        show: true,
                        fill: false
                    },
                    points: {
                        show: true,
                        radius: '1',
                        fillColor: '#000066'
                    },
                    color: '#000066'
                 },
                 {
                    label: "CPU Stats",
                    data: CPUData,
                    lines: {
                        show: true,
                        fill: false
                    },
                    points: {
                        show: true,
                        radius: '1',
                        fillColor: '#660066'
                    },
                    color: '#660066'
                 }
            ];

            var serverStats_plot = $.plot("#ServerStats", [serverStatsDataDetails], {
                grid: {
                    borderColor: "#819FF7",
                    borderWidth: 1,
                    tickColor: "#f3f3f3",
                    clickable: false,
                    hoverable: true

                },
                series: {
                    shadowSize: 0 // Drawing is faster without shadows

                },
                legend: {
                        position: "nw"
                },
                yaxis: {
                    min: 0,
                    max: 100,
                    show: true
                },
                xaxis: {
                    mode: "time",
                    monthNames: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                    show: false
                }
            });


            var TransferData = [];
            var HitRatio = [];
            var HitRate = [];
            var hitRatioDataDetails = [
                {
                    label: "Hit Ratio",
                    data: HitRatio,
                    lines: {
                        show: true,
                        fill: true
                    },
                    points: {
                        show: true,
                        radius: '1',
                        fillColor: '#006600'
                    },
                    color: '#006600'
                }
            ];

            var hitRatioStats_plot = $.plot("#HitRatioStats", [hitRatioDataDetails], {
                grid: {
                    borderColor: "#819FF7",
                    borderWidth: 1,
                    tickColor: "#f3f3f3",
                    clickable: false,
                    hoverable: true

                },
                series: {
                    shadowSize: 0 // Drawing is faster without shadows

                },
                legend: {
                        position: "nw"
                },
                yaxis: {
                    min: 0,
                    max: 100,
                    show: true
                },
                xaxis: {
                    mode: "time",
                    monthNames: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                    show: false
                }
            });

            var hitRateDataDetails = [
                {
                    label: "Hit Rate",
                    data: HitRate,
                    lines: {
                        show: true,
                        fill: true
                    },
                    points: {
                        show: true,
                        radius: '1',
                        fillColor: '#006600'
                    },
                    color: '#006600'
                }
            ];

            var hitRateStats_plot = $.plot("#HitRateStats", [hitRateDataDetails], {
                grid: {
                    borderColor: "#819FF7",
                    borderWidth: 1,
                    tickColor: "#f3f3f3",
                    clickable: false,
                    hoverable: true

                },
                legend: {
                        position: "nw"
                },
                series: {
                    shadowSize: 0 // Drawing is faster without shadows

                },
                yaxis: {
                    min: 0,
                    show: true
                },
                xaxis: {
                    mode: "time",
                    monthNames: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                    show: true
                }
            });

            var transferDataDetails = [
                {
                    label: "Transfer Data",
                    data: TransferData,
                    lines: {
                        show: true,
                        fill: true
                    },
                    points: {
                        show: true,
                        radius: '1',
                        fillColor: '#006600'
                    },
                    color: '#006600'
                }
            ];

            var transferStats_plot = $.plot("#transferStats", [transferDataDetails], {
                grid: {
                    borderColor: "#819FF7",
                    borderWidth: 1,
                    tickColor: "#f3f3f3",
                    clickable: false,
                    hoverable: true

                },
                legend: {
                        position: "nw"
                },
                series: {
                    shadowSize: 0 // Drawing is faster without shadows

                },
                yaxis: {
                    min: 0,
                    show: true
                },
                xaxis: {
                    mode: "time",
                    monthNames: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                    show: false
                }
            });

            var preClientReq = 0;
            var preClientReqTime = 0;
            var preBytesSent = 0;

            socket.on('VarnishStats', function(dataIn){
                
                var data = jQuery.parseJSON(dataIn);
                console.log(data);
                console.log(data.timestamp);
                var entryTimestamp = Date.parse( data.timestamp );

                if (CPUData.length > mpoints_max) {
                    HitRatio.splice(0, 1);
                    HitRate.splice(0, 1);
                    TransferData.splice(0, 1);
                }

                if (preClientReq == 0) {
                    preClientReqTime = entryTimestamp;
                    preClientReq = data["MAIN.client_req"].value;
                    preBytesSent = data["MAIN.s_resp_hdrbytes"].value + data["MAIN.s_resp_bodybytes"].value;
                }

                var statInterval = (entryTimestamp - preClientReqTime) / 1000;
                var hitRate = (data["MAIN.client_req"].value - preClientReq) / statInterval;
                preClientReqTime = entryTimestamp;
                preClientReq = data["MAIN.client_req"].value;

                HitRatio.push([entryTimestamp , data["MAIN.cache_hit"].value]);

                var bytesSent = ( data["MAIN.s_resp_hdrbytes"].value + data["MAIN.s_resp_bodybytes"].value - preBytesSent ) ;
                console.log('bytes sent ' +data["MAIN.s_resp_hdrbytes"].value + ' : ' +  data["MAIN.s_resp_bodybytes"].value + ' : ' + bytesSent) / 5;
                preBytesSent = data["MAIN.s_resp_hdrbytes"].value + data["MAIN.s_resp_bodybytes"].value;

                if (preClientReq != 0) {
                    HitRate.push([entryTimestamp , hitRate]);
                    $('#server-info-hitrate-knob').val(hitRate).trigger('change');
                    TransferData.push([entryTimestamp , bytesSent]);
                }

                hitRatioStats_plot.setData(hitRatioDataDetails);
                hitRateStats_plot.setData(hitRateDataDetails);
                transferStats_plot.setData(transferDataDetails);

                hitRatioStats_plot.setupGrid();
                hitRateStats_plot.setupGrid();
                transferStats_plot.setupGrid();

                hitRatioStats_plot.draw();
                hitRateStats_plot.draw();
                transferStats_plot.draw();
            });

            socket.on('VarnishAlert', function(dataIn) {
                var data = JSON.parse(dataIn);
                console.log(data);
                if (data.length > 1) {
                    for (var i=0;i<data.length;i++) {
                        console.log('Alert Severity : ' + data[i].errorSeverity + ' Msg: ' + data[i].errorMessage);
                        if (data[i].errorSeverity == "CRITICAL") {
                            $('#varnishAlerts').append('<div class="alert alert-danger alert-dismissable"><i class="fa fa-ban"></i> \
                                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button> \
                                    <b>Alert!</b> '+data[i].errorMessage+' \
                                </div>');
                        } else if (data[i].errorSeverity == "HARMLESS") {
                                $('#varnishAlerts').append('<div class="alert alert-success  alert-dismissable"><i class="fa fa-ban"></i> \
                                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button> \
                                    <b>Alert!</b> '+data[i].errorMessage+' \
                                </div>');
                        } else {
                                $('#varnishAlerts').append('<div class="alert alert-warning  alert-dismissable"><i class="fa fa-ban"></i> \
                                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button> \
                                    <b>Alert!</b> '+data[i].errorMessage+' \
                                </div>');
                        }

                    }
                } else {
                    console.log('Alert Severity : ' + data.errorSeverity + ' Msg: ' + data.errorMessage);
                        if (data.errorSeverity == "CRITICAL") {
                            $('#varnishAlerts').append('<div class="alert alert-danger alert-dismissable"><i class="fa fa-ban"></i> \
                                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button> \
                                    <b>Alert!</b> '+data.errorMessage+' \
                                </div>');
                        } else if (data.errorSeverity == "HARMLESS") {
                                $('#varnishAlerts').append('<div class="alert alert-success  alert-dismissable"><i class="fa fa-ban"></i> \
                                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button> \
                                    <b>Alert!</b> '+data.errorMessage+' \
                                </div>');
                        } else {
                                $('#varnishAlerts').append('<div class="alert alert-warning  alert-dismissable"><i class="fa fa-ban"></i> \
                                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button> \
                                    <b>Alert!</b> '+data.errorMessage+' \
                                </div>');
                        }
                }
            });

            socket.on('ServerInfo', function(data){
                console.log(data);
                // console.log(data.CPU);
                if (CPUData.length > mpoints_max) {
                    DiskData.splice(0, 1);
                    CPUData.splice(0, 1);
                    MemData.splice(0, 1);
                }

                DiskData.push([data.Timestamp , data.Disk ]);
                CPUData.push([data.Timestamp , data.CPU ]);
                MemData.push([data.Timestamp , 100-data.Memory ]);

                $('#server-info-cpu-knob').val(data.CPU).trigger('change');
                $('#server-info-memory-knob').val(100-data.Memory).trigger('change');
                $('#server-info-cpuload-knob').val(data.CPULoad*100).trigger('change');

                serverStats_plot.setData(serverStatsDataDetails);

                serverStats_plot.setupGrid();
                serverStats_plot.draw();
            });


        $(document).ready(function () {
            $("#HitRateStats").UseTooltip();
            $("#transferStats").UseTooltip();
            $("#HitRatioStats").UseTooltip();
            $("#ServerStats").UseTooltip();
        });


        function gd(year, month, day) {
            return new Date(year, month, day).getTime();
        }
 
        var previousPoint = null, previousLabel = null;
 
        $.fn.UseTooltip = function () {
            $(this).bind("plothover", function (event, pos, item) {
                if (item) {
                    if ((previousLabel != item.series.label) || (previousPoint != item.dataIndex)) {
                        previousPoint = item.dataIndex;
                        previousLabel = item.series.label;
                        $("#tooltip").remove();
 
                        var x = item.datapoint[0];
                        var y = item.datapoint[1];
 
                        var color = item.series.color;
                        // var timeEntry = new Date(x).getHours() + ':' + new Date(x).getMinutes() + ':' + new Date(x).getSeconds();

                        var today = new Date(x);
                        var date = ('0' + (today.getHours()+1)).slice(-2) + ':' + ('0' + (today.getMinutes()+1)).slice(-2) + ':' + ('0' + today.getSeconds()).slice(-2);

                        showTooltip(item.pageX,
                        item.pageY,
                        color,
                        "<strong>" + item.series.label + ' ' + y + "</strong><br />" + date);
                    }
                } else {
                    $("#tooltip").remove();
                    previousPoint = null;
                }
            });
        };
 
        function showTooltip(x, y, color, contents) {
            $('<div id="tooltip">' + contents + '</div>').css({
                position: 'absolute',
                display: 'none',
                top: y - 40,
                left: x - 40,
                border: '2px solid ' + color,
                padding: '3px',
                'font-size': '9px',
                'border-radius': '5px',
                'background-color': '#fff',
                'font-family': 'Verdana, Arial, Helvetica, Tahoma, sans-serif',
                opacity: 0.9
            }).appendTo("body").fadeIn(200);
        }

        </script>
            
    </body>
</html>